"use strict";!function(e,a){window.voyageMapDetails={tbody:e(".tbody_itinerary"),itineraryItemTmplt:e("#template-itinerary-item"),baseJSONpath:a.isMRM()?"/assets/dist/data/":"/capi/voyage/itineraryandmap/",baseAssetPath:a.isMRM()?"/":"/ResourcePackages/Talon/",shipRoute:"",shipPorts:"",footerText:"",portCoords:[],attractions:"",mapConfig:"",portConfig:[],map:"",$map_wrapper:e(".map_area"),$map_nav:e(".map_nav"),mapZoomOffset:.05,type:"ocean",skipMap:!1,initVoyageMapDetails:function(){var a=this;if(a.getVoyageId()){var t=a.getVoyageId();"R"===t.charAt(0)&&(a.type="river"),e("#currentVoyage").length>0&&this.initMap(a.getVoyageId())}this.customHandlers()},getVoyageId:function(){if(e("#currentVoyage").length>0)return e("#currentVoyage").attr("data-voyageid")},initMap:function(t,r,o,i,s){function n(e){if(e&&e.geometry&&e.geometry.coordinates.length>0){var a=turf.bezier(e,{resolution:5e4,sharpness:.2});"river"===c.type&&(a=e),a=e,c.shipRoute={type:"FeatureCollection",features:[a]}}}function p(a,t,r){m.then(function(o){var i;a?(i=a,n(i)):(i=o.RouteData,console.log(i),e("#currentVoyage").length>0&&(!i||0===i.geometry.coordinates.length)?(e(".view_list").click(),e(".view_select").hide(),c.skipMap=!0):(i&&0!==i.geometry.coordinates.length||(i={geometry:{coordinates:[[0,0],[0,0]]}}),n(i))),t?c.shipPorts=t:c.shipPorts=o.ports,c.attractions=o.attractions,c.footerText=o.footerText,e(".footerText").html(c.footerText);for(var s=0,p=c.shipPorts.length;s<p;s++)"undefined"!=typeof c.shipPorts[s].geometry&&c.shipPorts[s].geometry.coordinates.length>0&&c.portCoords.push(c.shipPorts[s].geometry.coordinates);console.log(r),r?c.mapConfig=r:o.mapConfig&&0!==o.mapConfig.center[0]&&0!==o.mapConfig.center[1]?c.mapConfig=o.mapConfig:c.mapConfig={center:c.getLatLngCenter(c.portCoords),zoom:5.1,maxZoom:14,minZoom:5.1},window.mainVariables.$window.on("resize",function(){var a=e(this);a.width()<=767?(c.mapZoomOffset=0,c.mapConfig.zoom=4,c.mapConfig.minZoom=4):c.mapZoomOffset=.05}).resize(),c.skipMap?e(".tbody_itinerary").length>0&&c.updateItineraryList():(c.buildMap(),e(".map_nav").hasClass("slick-initialized")||c.buildMapNav())})}var l="";r&&(l="/nocache");var m,c=this;m=a.isMRM()?window.mainVariables.getData(c.baseJSONpath+t+".geojson"):window.mainVariables.getData(c.baseJSONpath+t+l),s&&(c.type=s),p(r,o,i)},buildMapNav:function(){for(var e=this,a="",t=0,r=e.shipPorts.length;t<r;t++)if("undefined"!=typeof e.shipPorts[t].geometry&&e.shipPorts[t].geometry.coordinates.length>0){var o=e.shipPorts[t].properties.cruiseDay;o=o.split(" ");var i=o[0].replace(".","")+" "+parseInt(o[1].replace(",",""),10),s="";s="<div>",s+='<a href="#" class="day" data-index="'+t+'" data-place-name="'+e.shipPorts[t].properties.placeName+'" data-map-lng="'+e.shipPorts[t].geometry.coordinates[0]+'" data-map-lat="'+e.shipPorts[t].geometry.coordinates[1]+'">',s+='<span class="date">Day <b>'+e.shipPorts[t].properties.dayNumber+'</b> <span class="cal_date">'+i+"</span></span>",s+='<span class="place">'+e.shipPorts[t].properties.placeName+", <span>"+e.shipPorts[t].properties.country+"</span></span>",s+="</a>",s+="</div>",a+=s}e.$map_nav.append(a),e.addClickHandler(),e.$map_nav.slick({variableWidth:!0,infinite:!1,slidesToShow:4,slidesToScroll:1,responsive:[{breakpoint:768,settings:{slidesToShow:3,slidesToScroll:1,infinite:!1}},{breakpoint:670,settings:{slidesToShow:2,slidesToScroll:1,infinite:!1}},{breakpoint:480,settings:{slidesToShow:1,slidesToScroll:1,infinite:!1}}]})},buildMap:function(){var a=this;mapboxgl.accessToken="pk.eyJ1IjoiY3J5c3RhbGNydWlzZXMiLCJhIjoiY2pvZXc1ajZ6MDFoaDNsbnYxcWwwc2RociJ9.UFfseq4ICiTiLmjvjiYyPw",a.map=new mapboxgl.Map({container:"voyage_map",style:"mapbox://styles/crystalcruises/cjoew32kt1en62sl8b5at422u",center:a.mapConfig.center,zoom:a.mapConfig.zoom,maxZoom:parseFloat(a.mapConfig.maxZoom),minZoom:parseFloat(a.mapConfig.minZoom),doubleClickZoom:!1,setClickableIcons:!0,inertia:!0,interactive:!0,attributionControl:{compact:!0}}),a.map.addControl(new mapboxgl.NavigationControl),a.map.scrollZoom.disable(),a.map.on("load",function(){a.map.loadImage(a.baseAssetPath+"assets/dist/images/map_2px_main_pin.png",function(e,t){if(e)throw e;a.map.addImage("marker_port_large",t),a.map.loadImage(a.baseAssetPath+"assets/dist/images/map_2px_small_pin.png",function(e,t){if(e)throw e;a.map.addImage("marker_port_small_green",t),a.map.loadImage(a.baseAssetPath+"assets/dist/images/map_2px_small_pin_diamond.png",function(e,t){if(e)throw e;a.map.addImage("marker_port_small",t),"river"===a.type&&a.map.addLayer({id:"riverThickener",type:"line",source:{type:"geojson",data:a.shipRoute},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#d2f1f2","line-width":10}}),a.map.addLayer({id:"line1",type:"line",source:{type:"geojson",data:a.shipRoute},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#000","line-width":1.5,"line-dasharray":[1,2]}}),a.map.addLayer({id:"ports",type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:a.shipPorts}},layout:{"icon-image":"{markerSymbol}","text-field":"{placeName}","text-font":["Montserrat Bold","Arial Unicode MS Bold"],"text-size":12,"text-offset":["case",["==",["get","textAnchor"],"bottom-left"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,-5.7]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,-3.8]],["literal",[0,-1]]],["==",["get","textAnchor"],"bottom-right"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,-5.7]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,-3.8]],["literal",[0,-1]]],["==",["get","textAnchor"],"top-left"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,.5]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,.5]],["literal",[0,1.25]]],["==",["get","textAnchor"],"top-right"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,.5]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,.5]],["literal",[0,1.25]]],["==",["get","textAnchor"],"top"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,.5]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,.5]],["literal",[0,1.25]]],["==",["get","textAnchor"],"bottom"],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,-5.7]],["==",["get","markerSymbol"],"marker_port_small_green"],["literal",[0,-3.8]],["literal",[0,-1.2]]],["case",["==",["get","markerSymbol"],"marker_port_large"],["literal",[0,-5.7]],["literal",[0,-1.2]]]],"text-anchor":["case",["has","textAnchor"],["get","textAnchor"],"bottom"],"icon-anchor":["case",["==",["get","markerSymbol"],"marker_port_small"],"center","bottom"],"icon-allow-overlap":!0,"text-optional":!0,"text-letter-spacing":.15,"icon-size":.65},paint:{"text-color":"#000","text-halo-color":"#fff","text-halo-width":2}}),a.map.addLayer({id:"attractions",type:"symbol",source:{type:"geojson",data:{type:"FeatureCollection",features:a.attractions}},minzoom:12,layout:{"icon-image":"{markerSymbol}","text-font":["Montserrat Bold","Arial Unicode MS Bold"],"text-size":12,"text-offset":[0,-3.754],"text-anchor":"top","icon-anchor":"bottom","text-letter-spacing":.25,"icon-size":.4}})})})}),a.map.on("click","ports",function(t){window.mainVariables.scrollToN(e("#voyage_map").offset().top-window.Details.$navbar.height()-window.Details.$mapNav.height(),500);var r=e('a.day[data-place-name="'+t.features[0].properties.placeName+'"]');a.map.flyTo({center:[t.features[0].geometry.coordinates[0]+a.mapZoomOffset,t.features[0].geometry.coordinates[1]],zoom:12,speed:1.5,curve:1,easing:function(e){return e}}).once("moveend",function(){a.showMapBox(r)})}),a.map.on("click","attractions",function(e){var t=e.features[0].geometry.coordinates.slice(),r=e.features[0].properties.placeName,o=e.features[0].properties.category,i='<span class="category">'+o+"</span>";for(i+='<span class="name">'+r+"</span>",e.features[0].properties.panoramaLat&&(i+='<a class="pano" href="panoramic.html?lat='+e.features[0].properties.panoramaLat+"&lng="+e.features[0].properties.panoramaLng+'" target="_blank">View 360&deg;</a>');Math.abs(e.lngLat.lng-t[0])>180;)t[0]+=e.lngLat.lng>t[0]?360:-360;(new mapboxgl.Popup).setLngLat(t).setHTML(i).addTo(a.map)}),a.map.on("zoomend",function(){var t=a.map.getZoom();t<=a.mapConfig.zoom&&(a.$map_wrapper.removeClass("port_summary_show"),e("a.day").removeClass("active"),e(".full_itinerary").addClass("active"))}),a.map.scrollZoom.disable()}),window.voyageMap=a.map},resetMap:function(){var e=this;e.map.jumpTo({center:e.mapConfig.center,zoom:e.mapConfig.zoom,speed:1.5,curve:1,easing:function(e){return e}})},addClickHandler:function(){var a=this;e(".map_nav ").on("click",".full_itinerary",function(t){t.preventDefault(),t.stopPropagation(),a.$map_wrapper.removeClass("port_summary_show"),t.preventDefault(),e("a.day").removeClass("active"),e(this).addClass("active"),a.resetMap(),window.mainVariables.scrollToN(e("#voyage_map").offset().top-window.Details.$navbar.height()-window.Details.$mapNav.height()-25,500)}),a.$map_wrapper.on("click",".port_nav a",function(t){t.preventDefault(),t.stopPropagation();var r=e(this),o=Number(e("a.day.active").closest(".slick-slide").attr("data-slick-index"))+1;r.hasClass("a_prev")&&(o=Number(e("a.day.active").closest(".slick-slide").attr("data-slick-index"))-1),e('div[data-slick-index="'+o+'"] a.day').click(),e('div[data-slick-index="'+o+'"]').hasClass("slick-active")||(r.hasClass("a_prev")?a.$map_nav.slick("slickPrev"):a.$map_nav.slick("slickNext")),window.mainVariables.scrollToN(e("#voyage_map").offset().top-window.Details.$navbar.height()-window.Details.$mapNav.height()-25,500)}),e(".map_nav ").on("click","a.day:not(.full_itinerary)",function(t){t.preventDefault(),t.stopPropagation(),window.mainVariables.scrollToN(e("#voyage_map").offset().top-window.Details.$navbar.height()-window.Details.$mapNav.height()-25,500);var r=e(this);a.showMapBox(r),a.map.jumpTo({center:[Number(r.attr("data-map-lng"))+a.mapZoomOffset,Number(r.attr("data-map-lat"))],zoom:12,speed:1.5,curve:1,easing:function(e){return e}})}),e(".tbody_itinerary").length>0&&a.updateItineraryList()},showMapBox:function(a){var t=this;console.log(t.shipPorts.length,Number(a.attr("data-index"))),0===Number(a.attr("data-index"))?t.$map_wrapper.addClass("port_prev_hide"):Number(a.attr("data-index"))===t.shipPorts.length-1?t.$map_wrapper.addClass("port_next_hide"):t.$map_wrapper.removeClass("port_prev_hide port_next_hide"),t.$map_wrapper.addClass("port_summary_show loadingMapSummary");var r=t.shipPorts[a.attr("data-index")],o=r.properties.description;o.length>100&&(o=o.substring(0,115)+"..."),setTimeout(function(){if(t.$map_wrapper.find(".port_summary img").attr({src:r.properties.img,alt:r.properties.alt}),r.properties.isMaidenCall||r.properties.isPortTransfer){var e="";r.properties.isMaidenCall&&(e+="<h6>Maiden Port Call</h6>"),r.properties.isPortTransfer&&(e+="<h6>Port Transfer</h6>"),t.$map_wrapper.find(".port_summary .port_title").html(e)}else t.$map_wrapper.find(".port_summary .port_title").html("");t.$map_wrapper.find(".port_summary h5").html(r.properties.title),t.$map_wrapper.find(".port_summary p").html(o),t.$map_wrapper.find("a.modal-link").attr("data-url","/tour/port/"+r.properties.urlName)},300),setTimeout(function(){t.$map_wrapper.removeClass("loadingMapSummary")},300),e("a.day").removeClass("active"),a.addClass("active")},customHandlers:function(){},updateItineraryList:function(){for(var e=this,a="",t=0;t<e.shipPorts.length;t++){var r=e.itineraryItemTmplt.clone();r=r.html();for(var o in e.shipPorts[t].properties){var i="%"+o+"%",s=new RegExp(i,"g");if("cruiseDay"===o){var n=e.shipPorts[t].properties[o];r=r.replace("%cruiseDay%",n)}else if("arrivalText"===o&&""===e.shipPorts[t].properties[o]){r=r.replace(s,"-");var p=new RegExp('td_arrival"',"g");r=r.replace(p,'td_arrival only_desktop_content"')}else if("country"===o)""!==e.shipPorts[t].properties[o]?(r=r.replace(s,", "+e.shipPorts[t].properties[o]),r=r.replace(" ,",",")):r=r.replace(s,"");else if("isMaidenCall"===o){var l=e.shipPorts[t].properties[o];r=l?r.replace(s,"<br><small>Maiden Port Call</small>"):r.replace(s,"")}else if("isPortTransfer"===o){var m=e.shipPorts[t].properties[o];r=m?r.replace(s,"<br><small>Port Transfer</small>"):r.replace(s,"")}else"urlName"===o?(console.log(e.shipPorts[t].properties),r=null===e.shipPorts[t].properties.portId?r.replace("%extraclass%","hidden"):e.shipPorts[t].properties[o]?r.replace("%portUrl%","/tour/port/"+e.shipPorts[t].properties[o]):r.replace("%portUrl%","")):r=r.replace(s,e.shipPorts[t].properties[o])}a+=r}e.itineraryItemTmplt.remove(),e.tbody.append(a)},saveMapImage:function(a){var t=this,r=e(".image-container"),o=t.map.getCanvas().toDataURL(),i=new Image;i.src=o;var s='<a title="Spain Voyage" href="'+o+'" download class="button-outline">Download Image</a>';r.prepend(i),r.prepend(s)},mapUtilities:{rad2degr:function(e){return 180*e/Math.PI},degr2rad:function(e){return e*Math.PI/180}},getLatLngCenter:function(e){for(var a=this.mapUtilities,t=1,r=0,o=0,i=0,s=0,n=0;n<e.length;n++){var p=a.degr2rad(e[n][t]),l=a.degr2rad(e[n][r]);o+=Math.cos(p)*Math.cos(l),i+=Math.cos(p)*Math.sin(l),s+=Math.sin(p)}var m=o/e.length,c=i/e.length,d=s/e.length,g=Math.atan2(c,m),h=Math.sqrt(m*m+c*c),f=Math.atan2(d,h);return[a.rad2degr(g),a.rad2degr(f)]}}}(jQuery,window.talonUtil);